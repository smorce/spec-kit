# 1. ゴール / コンテキスト

- Memorium記憶管理フローのMVPを実装し、チャット入力→プレビュー→承認→保存→検索→プロファイル反映まで一貫した体験を提供する。
- 000-architectureのサービス分割を前提に、BFF (orchestrator-gateway) と各サービスのAPI契約を固定し、MiniRAGによる検索統合を実現する。
- スコープは単一ユーザー、ローカル稼働、暗号化なし。

# 2. スコープと非スコープ

## スコープ
- ジャーナルセッション管理、深掘り質問とプレビュー生成のワークフロー。
- プレビュー承認による記憶保存、エンティティ抽出の提示。
- MiniRAGを用いたキーワード/意味/関係検索の並列実行と結合表示。
- YAMLプロファイルの更新と差分要約の提示。
- SignalR Hubを介したリアルタイム通知。

## 非スコープ
- マルチユーザー、アクセス権限管理。
- 記憶削除、編集履歴管理。
- 暗号化、外部バックアップ。

# 3. TDD実行戦略

1. **契約テスト先行**: OpenAPI/SignalR契約・MiniRAGインターフェースのスキーマをschemathesis/pytestで検証。
2. **Red-Green-Refactorサイクル**: 各サービス単位で最小の失敗テストを記述し、ビジネスロジックをミニマム実装→リファクタリング。
3. **テスト階層**:
   - ユニット: 質問生成ロジック、スコアフィルタ、プロファイル差分。
   - コンポーネント: セッション→プレビュー→保存のサービス連携をWireMockでスタブ化。
   - E2E: Compose上でFront-APIを含む契約シナリオ（保存と検索）を自動再現。
4. **Tidy First**: プラン達成まで振る舞い変更と構造整理を分離。

# 4. インクリメント計画

| Sprint | 目標 | 主なアウトプット |
|--------|------|------------------|
| Sprint 1 | セッション基盤整備 | Journal Ingestion API, SignalR sessionStateUpdated |
| Sprint 2 | プレビュー生成と承認 | Preview Orchestrator連携、プレビュー契約、commitフロー |
| Sprint 3 | 記憶保存とプロファイル更新 | Memory Vault保存、エンティティ抽出、プロファイル差分提示 |
| Sprint 4 | 検索統合 | MiniRAG検索・フィルタリング、searchCompleted通知 |
| Sprint 5 | 非機能仕上げ | 観測性、バックアップ手順、性能測定、CI整備 |

# 5. テスト計画

- **受け入れテスト**: SpecのP1〜P3ユーザーストーリーをPlaywright + APIスタブで自動化。
- **検索整合性テスト**: MiniRAG Index投入後、期待ヒット件数を測る再現性テストをPyTestで用意。
- **プロファイル差分テスト**: YAML差分生成のSnapshotテストを実施。
- **負荷テスト**: k6で検索APIの同時リクエスト10件、応答時間目標2秒以内を検証。

# 6. 依存関係

- MiniRAG (documents/MiniRAG) コンテナ群の起動。
- Postgres + pgvectorマイグレーション (`002_add_text_field_to_existing_chunks.sql`)。
- Frontendリポジトリ資料に基づくUI実装（SignalRクライアント）。

# 7. リスクと緩和策

| リスク | 影響 | 緩和策 |
|--------|------|--------|
| プレビュー生成品質が期待値を満たさない | UX低下 | プロンプトテンプレートを仕様化し、Goldテストケースを作成 |
| MiniRAG検索遅延 | 検索応答超過 | 事前インデックス、キャッシュ層導入、閾値調整 |
| YAMLプロファイル競合 | 差分破損 | ファイルロック＋バージョン履歴をProfileSnapshotテーブルで管理 |
| SignalR切断 | 体験中断 | 再接続ポリシーと未同期イベントのRESTフォールバック |
