# Feature Specification: Memorium記憶管理フロー

**Feature Branch**: `001-memorium-md`  
**Created**: 2025-10-26  
**Status**: Draft  
**Input**: User description: "Memorium.md を確認してください。"

## Clarifications

### Session 2025-10-26

- Q: 記憶データの保存場所とセキュリティ方針は？ → A: ローカル端末に平文保存

## User Scenarios & Testing *(mandatory)*

### User Story 1 - チャット経由で日記を構造化する (Priority: P1)

ユーザーがチャットUIで日記を入力すると、システムが深掘り質問を行いながら内容を整理し、保存前に整形済みプレビューを提示する。

**Why this priority**: 記憶化フローの起点であり、ここが成立しないと他の価値が一切生まれないため。

**Independent Test**: モック日記を入力してプレビュー（重要度・記憶タイプ・構造化テキスト・サマリー・解説）が生成されることを確認すれば完結する。

**Acceptance Scenarios**:

1. **Given** ユーザーが新規セッションを開始して日記の下書きを入力している, **When** システムが追加入力を促す質問を出しユーザーが回答する, **Then** プレビューにすべての必須フィールドが埋まり承認待ち状態になる。
2. **Given** プレビューが提示されている, **When** ユーザーが内容を修正したいと指示する, **Then** システムが編集ラウンドを再開し再度プレビューを更新する。

---

### User Story 2 - 保存後に抽出エンティティとプロファイルを確認する (Priority: P2)

ユーザーがプレビューを承認すると保存が実行され、その回で抽出されたエンティティ一覧と更新後の個人プロファイル要約が表示される。

**Why this priority**: 保存結果を即座に確認できれば入力内容の信頼性と学習効果を高められるため。

**Independent Test**: 保存後に表示されるエンティティとプロファイル差分が期待通りであるかを検証すれば単独で価値を測定できる。

**Acceptance Scenarios**:

1. **Given** ユーザーがプレビューを承認した, **When** システムが保存処理を完了する, **Then** 当回で抽出されたエンティティ一覧と重要度・記憶タイプを含む保存内容概要が表示される。
2. **Given** プロファイルが既存で存在する, **When** 保存後の更新が行われる, **Then** YAML形式のプロファイルに価値観・思考傾向・言葉遣いが追記または調整され更新結果がユーザーに要約表示される。

---

### User Story 3 - 自然文検索で複数軸から記憶を引き出す (Priority: P3)

ユーザーが自然文クエリを入力すると、キーワード検索・意味検索・関係検索が並列に動き、フィルタを適用した合成結果が提示される。

**Why this priority**: 記憶を活用する主目的に直結し、保存した価値を引き出すために必須な体験だから。

**Independent Test**: 代表的なクエリを入力し、3系統検索が同時に実行され0件ソースが除外された結合結果が提示されるかを確認するだけで成立する。

**Acceptance Scenarios**:

1. **Given** ユーザーが検索UIで重要度と日付フィルタを設定している, **When** 自然文クエリを送信する, **Then** 条件に合致するキーワード・意味・関係検索の結果のみが結合され、ソース区別とメタ情報付きで提示される。
2. **Given** いずれかの検索軸で閾値未満の結果しか得られない, **When** システムが結果を評価する, **Then** 閾値未満の軸は非表示となり残りの結果だけが統合表示される。

---

### Edge Cases

- プレビュー前にユーザーがセッションを離脱した場合、入力内容を一時保存し次回再開できるようにする。
- ユーザーが短文のみ入力し十分な情報が得られない場合は、保存を許可せず追加入力を促す。
- プレビューと保存内容に矛盾が生じた場合（例: 修正直後に承認したケース）は最新編集内容で上書き保存する。
- 検索フィルタが結果をゼロ件に絞り込んだ場合は「該当記憶なし」を通知しクエリ修正ガイダンスを出す。
- プロファイル更新で既存属性と衝突する場合は重み付けや履歴を用いて整合性ルールに従い調整する。

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは単一ユーザー向けに日次でチャットセッションを開始し、途中離脱に備えてセッション状態を保持しなければならない。
- **FR-002**: システムは日記入力中に内容を深掘りする質問を提示し、ユーザーが回答するたびにプレビュー候補を更新しなければならない。
- **FR-003**: プレビューには重要度(1〜10整数)、記憶タイプ分類（セマンティック・エピソード）、構造化された日記本文、サマリー、解説が含まれ、承認前にユーザーが確認できなければならない。
- **FR-004**: ユーザーが修正を要求した場合、システムは編集フェーズに戻し最新の入力でプレビューを再生成しなければならない。
- **FR-005**: ユーザーがプレビューを承認すると、セマンティック記憶、エピソード記憶、構造化本文、サマリー、メタデータ（重要度等）を永続化しなければならない。
- **FR-006**: 保存完了時に当回で抽出されたエンティティ一覧と重要度・記憶タイプなどのハイライトをユーザーに提示しなければならない。
- **FR-007**: 保存処理の後、価値観・思考傾向・言葉遣いを含む個人プロファイルをYAML形式で更新し、差分をユーザーに共有しなければならない。
- **FR-008**: 検索UIは自然文クエリの入力を受け付け、事前に重要度と日付範囲フィルタを設定できるようにしなければならない。
- **FR-009**: システムはクエリ受信後にキーワード、意味、関係の3系統検索を並列実行し、それぞれの結果を評価して閾値未満または0件のソースを除外しなければならない。
- **FR-010**: 絞り込まれた検索結果はソース種別と関連メタ情報を保持したまま結合表示され、ユーザーが各項目を個別に参照できなければならない。
- **FR-011**: ユーザーが保存済み記憶を削除したい場合のワークフローはMVPスコープ外であることを明示し、操作を提供しない。

### Key Entities *(include if feature involves data)*

- **JournalSession**: ユーザーが日記を入力する1回の対話単位。状態（進行中・プレビュー済み・承認済み）と入力履歴を保持。
- **MemoryRecord**: 承認後に保存される記憶データ。重要度、記憶タイプ別配列、構造化本文、サマリー、メタデータを含む。
- **ExtractedEntity**: 保存時に抽出される人物・場所・トピックなどのラベルとスコア。保存完了画面で提示。
- **PersonalProfile**: ユーザーの価値観・思考傾向・言葉遣いをYAMLで保持する長期的プロファイル。更新履歴と差分通知の基礎。
- **SearchResultBundle**: キーワード・意味・関係検索のそれぞれの結果集合とメタ情報を統合した提示用データ構造。

## Assumptions

- MVPでは同時複数セッションは不要とし、1ユーザー・1セッションのみを想定する。
- プロファイルのYAMLはサイズが小さいため手動バックアップや履歴管理は後続フェーズで扱う。
- 検索の閾値基準は内部で調整し、ユーザーが閾値を変更する設定はMVPでは提供しない。
- 保管コスト最小化の観点で記憶データはローカル端末に平文で保存し、OS側のアクセス制御に依存する。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 日記セッション開始から保存承認までの平均所要時間が5分以内に収まる。
- **SC-002**: プレビュー提示時点で必須フィールド（重要度・記憶タイプ・構造化本文・サマリー・解説）の欠落率が0%である。
- **SC-003**: 保存完了後に表示されるエンティティリストのユーザー確認率（ユーザーが内容を最後までスクロールする割合）が90%以上である。
- **SC-004**: 自然文検索に対して90%のケースで3系統のうち少なくとも1系統から関連結果が提示される。
- **SC-005**: プロファイル更新の要約に対する主観的満足度（ユーザー自己評価）が4/5以上を維持する。
