{
  "openapi": "3.0.3",
  "info": {
    "title": "Memorium Memory Orchestration API",
    "version": "0.1.0",
    "description": "ジャーナル入力から記憶保存と検索までを統括するBFF API"
  },
  "servers": [
    {
      "url": "http://localhost:8080/api/v1",
      "description": "ローカル開発用API Gateway"
    }
  ],
  "paths": {
    "/journal-sessions": {
      "post": {
        "summary": "ジャーナルセッション開始",
        "description": "新しいジャーナルセッションを開始し、初期入力を登録する",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/CreateJournalSessionRequest"
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "セッション作成済み",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/JournalSessionResponse"
                }
              }
            }
          }
        }
      }
    },
    "/journal-sessions/{sessionId}": {
      "get": {
        "summary": "セッション進行状況取得",
        "parameters": [
          {
            "$ref": "#/components/parameters/SessionIdPath"
          }
        ],
        "responses": {
          "200": {
            "description": "セッション状態を返却",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/JournalSessionResponse"
                }
              }
            }
          }
        }
      }
    },
    "/journal-sessions/{sessionId}/messages": {
      "post": {
        "summary": "ユーザーの追加入力を反映",
        "parameters": [
          {
            "$ref": "#/components/parameters/SessionIdPath"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/PostMessageRequest"
              }
            }
          }
        },
        "responses": {
          "202": {
            "description": "メッセージを受理し、プレビュー更新が開始された",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/JournalSessionResponse"
                }
              }
            }
          }
        }
      }
    },
    "/journal-sessions/{sessionId}/preview": {
      "get": {
        "summary": "最新プレビュー取得",
        "parameters": [
          {
            "$ref": "#/components/parameters/SessionIdPath"
          }
        ],
        "responses": {
          "200": {
            "description": "現在のプレビュースナップショット",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/PreviewResponse"
                }
              }
            }
          },
          "204": {
            "description": "プレビューが未生成"
          }
        }
      }
    },
    "/journal-sessions/{sessionId}/preview/confirm": {
      "post": {
        "summary": "プレビュー承認と保存",
        "parameters": [
          {
            "$ref": "#/components/parameters/SessionIdPath"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/ConfirmPreviewRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "記憶の保存が完了し、ハイライトとプロファイル差分を返却",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/MemoryCommitResponse"
                }
              }
            }
          }
        }
      }
    },
    "/search": {
      "get": {
        "summary": "自然文検索を実行",
        "parameters": [
          {
            "name": "query",
            "in": "query",
            "required": true,
            "schema": {
              "type": "string",
              "minLength": 1
            },
            "description": "自然文の検索クエリ"
          },
          {
            "name": "importance",
            "in": "query",
            "required": false,
            "schema": {
              "type": "integer",
              "minimum": 1,
              "maximum": 10
            },
            "description": "重要度によるフィルタ（下限値）"
          },
          {
            "name": "from",
            "in": "query",
            "required": false,
            "schema": {
              "type": "string",
              "format": "date"
            },
            "description": "日付フィルタ（開始日）"
          },
          {
            "name": "to",
            "in": "query",
            "required": false,
            "schema": {
              "type": "string",
              "format": "date"
            },
            "description": "日付フィルタ（終了日）"
          }
        ],
        "responses": {
          "200": {
            "description": "結合済み検索結果",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SearchResponse"
                }
              }
            }
          }
        }
      }
    },
    "/profile": {
      "get": {
        "summary": "最新プロファイル要約取得",
        "responses": {
          "200": {
            "description": "プロファイル要約と履歴メタ情報",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ProfileResponse"
                }
              }
            }
          }
        }
      }
    }
  },
  "components": {
    "parameters": {
      "SessionIdPath": {
        "name": "sessionId",
        "in": "path",
        "required": true,
        "schema": {
          "type": "string",
          "format": "uuid"
        },
        "description": "ジャーナルセッション識別子"
      }
    },
    "schemas": {
      "CreateJournalSessionRequest": {
        "type": "object",
        "required": ["initialEntry"],
        "properties": {
          "initialEntry": {
            "type": "string",
            "description": "ユーザー初回入力（未整形テキスト）"
          }
        }
      },
      "JournalSessionResponse": {
        "type": "object",
        "required": ["sessionId", "status", "messages", "startedAt"],
        "properties": {
          "sessionId": {
            "type": "string",
            "format": "uuid"
          },
          "status": {
            "type": "string",
            "enum": ["draft", "previewing", "ready", "committed"]
          },
          "messages": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/SessionMessage"
            }
          },
          "preview": {
            "$ref": "#/components/schemas/Preview"
          },
          "startedAt": {
            "type": "string",
            "format": "date-time"
          },
          "updatedAt": {
            "type": "string",
            "format": "date-time"
          }
        }
      },
      "SessionMessage": {
        "type": "object",
        "required": ["role", "content", "timestamp"],
        "properties": {
          "role": {
            "type": "string",
            "enum": ["user", "assistant"]
          },
          "content": {
            "type": "string"
          },
          "timestamp": {
            "type": "string",
            "format": "date-time"
          }
        }
      },
      "PostMessageRequest": {
        "type": "object",
        "required": ["content"],
        "properties": {
          "content": {
            "type": "string",
            "description": "ユーザー追加入力"
          }
        }
      },
      "Preview": {
        "type": "object",
        "required": ["importance", "memoryTypes", "structuredJournal", "summary", "commentary"],
        "properties": {
          "importance": {
            "type": "integer",
            "minimum": 1,
            "maximum": 10
          },
          "memoryTypes": {
            "$ref": "#/components/schemas/MemoryTypes"
          },
          "structuredJournal": {
            "type": "string",
            "description": "整形済みジャーナルテキスト"
          },
          "summary": {
            "type": "string",
            "description": "要約"
          },
          "commentary": {
            "type": "string",
            "description": "解説コメント"
          }
        }
      },
      "MemoryTypes": {
        "type": "object",
        "required": ["semantic", "episodic"],
        "properties": {
          "semantic": {
            "type": "array",
            "items": {
              "type": "string"
            }
          },
          "episodic": {
            "type": "array",
            "items": {
              "type": "string"
            }
          }
        }
      },
      "PreviewResponse": {
        "allOf": [
          {
            "$ref": "#/components/schemas/Preview"
          },
          {
            "type": "object",
            "properties": {
              "lastUpdated": {
                "type": "string",
                "format": "date-time"
              }
            }
          }
        ]
      },
      "ConfirmPreviewRequest": {
        "type": "object",
        "properties": {
          "overrideImportance": {
            "type": "integer",
            "minimum": 1,
            "maximum": 10
          },
          "notes": {
            "type": "string",
            "description": "保存前に追記したい補足"
          }
        }
      },
      "MemoryCommitResponse": {
        "type": "object",
        "required": ["memory", "entities", "profileDiff"],
        "properties": {
          "memory": {
            "$ref": "#/components/schemas/MemoryRecord"
          },
          "entities": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/ExtractedEntity"
            }
          },
          "profileDiff": {
            "$ref": "#/components/schemas/ProfileDiff"
          }
        }
      },
      "MemoryRecord": {
        "type": "object",
        "required": ["memoryId", "importance", "memoryTypes", "structuredJournal", "summary", "metadata", "createdAt"],
        "properties": {
          "memoryId": {
            "type": "string",
            "format": "uuid"
          },
          "importance": {
            "type": "integer",
            "minimum": 1,
            "maximum": 10
          },
          "memoryTypes": {
            "$ref": "#/components/schemas/MemoryTypes"
          },
          "structuredJournal": {
            "type": "string"
          },
          "summary": {
            "type": "string"
          },
          "metadata": {
            "type": "object",
            "additionalProperties": true
          },
          "createdAt": {
            "type": "string",
            "format": "date-time"
          }
        }
      },
      "ExtractedEntity": {
        "type": "object",
        "required": ["label", "category", "score"],
        "properties": {
          "label": {
            "type": "string"
          },
          "category": {
            "type": "string",
            "enum": ["person", "place", "topic", "object", "event"]
          },
          "score": {
            "type": "number",
            "format": "float",
            "minimum": 0,
            "maximum": 1
          }
        }
      },
      "ProfileDiff": {
        "type": "object",
        "required": ["previousVersion", "currentVersion", "highlights"],
        "properties": {
          "previousVersion": {
            "type": "string",
            "description": "更新前プロファイルのYAMLスナップショット"
          },
          "currentVersion": {
            "type": "string",
            "description": "更新後プロファイルのYAMLスナップショット"
          },
          "highlights": {
            "type": "array",
            "items": {
              "type": "string"
            }
          }
        }
      },
      "SearchResponse": {
        "type": "object",
        "required": ["query", "appliedFilters", "sources"],
        "properties": {
          "query": {
            "type": "string"
          },
          "appliedFilters": {
            "type": "object",
            "properties": {
              "importance": {
                "type": "integer"
              },
              "from": {
                "type": "string",
                "format": "date"
              },
              "to": {
                "type": "string",
                "format": "date"
              }
            }
          },
          "sources": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/SearchSourceResult"
            }
          }
        }
      },
      "SearchSourceResult": {
        "type": "object",
        "required": ["source", "results"],
        "properties": {
          "source": {
            "type": "string",
            "enum": ["keyword", "semantic", "relation"]
          },
          "results": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/SearchResultItem"
            }
          }
        }
      },
      "SearchResultItem": {
        "type": "object",
        "required": ["memoryId", "summary", "snippet", "score", "metadata"],
        "properties": {
          "memoryId": {
            "type": "string",
            "format": "uuid"
          },
          "summary": {
            "type": "string"
          },
          "snippet": {
            "type": "string"
          },
          "score": {
            "type": "number",
            "format": "float"
          },
          "metadata": {
            "type": "object",
            "properties": {
              "importance": {
                "type": "integer"
              },
              "createdAt": {
                "type": "string",
                "format": "date-time"
              },
              "memoryTypes": {
                "$ref": "#/components/schemas/MemoryTypes"
              },
              "sourceField": {
                "type": "string"
              }
            },
            "additionalProperties": false
          }
        }
      },
      "ProfileResponse": {
        "type": "object",
        "required": ["lastUpdated", "currentProfile", "recentHighlights"],
        "properties": {
          "lastUpdated": {
            "type": "string",
            "format": "date-time"
          },
          "currentProfile": {
            "type": "string",
            "description": "現行プロファイルのYAML"
          },
          "recentHighlights": {
            "type": "array",
            "items": {
              "type": "string"
            }
          }
        }
      }
    }
  }
}
