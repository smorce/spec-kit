目的:
- セキュリティチェック用のチェックリストを生成・更新する。
- ただし、今回の仕様とは合わないものは除外する。不明な場合はユーザーに確認する。

適用範囲:
- [000-architecture] 全体アーキテクチャの基盤原則
- 001- 以降の各 feature（＝各マイクロサービス）

前提スタック:
- ローカルでの開発(個人プロジェクト)
- データの暗号化はしない
- データインサートと検索は MiniRAG フレームワーク(Python)を利用する
  - documents/MiniRAG

指示:
- 生成物は `specs/[ブランチ名]/checklists/security.md` に Markdown として**上書き保存**。

# 統合セキュリティガイドライン チェックリスト

このチェックリストは今回のプロダクト仕様に合わせて適切に使用し、不要なものは省いてください。このチェックリストはあくまでも汎用的なリストになっています。

## 1. 暗号化

-   [ ] **アルゴリズム:** 最新の検証済み暗号アルゴリズム（共通鍵：AES-GCM, ChaCha20-Poly1305 / 公開鍵：RSA >= 2048, ECC / ハッシュ：SHA-256+）を使用しているか。
-   [ ] **キー管理:** キーは安全なKMSまたはHSMで生成・保管されているか。
-   [ ] **キーのハードコード禁止:** キーはソースコードにハードコードされていないか。
-   [ ] **キーのローテーション:** キーは定期的、および侵害発生時にローテーションされているか。
-   [ ] **TLS:** 強力な暗号スイートを持つTLS 1.3または1.2を使用しているか。
-   [ ] **古いプロトコルの無効化:** SSL, TLS 1.0, TLS 1.1は無効化されているか。
-   [ ] **HSTS:** HTTP Strict Transport Security (HSTS) は実装されているか。
-   [ ] **証明書ピニング:** 証明書ピニングは、クライアントとサーバーを両方制御できる環境でのみ、注意して使用されているか。

## 2. APIとWebサービス

-   [ ] **トランスポートセキュリティ:** すべてのAPIトラフィックにHTTPSを使用しているか。
-   [ ] **認証と認可:** OAuth2/OIDCのような標準的な認証プロトコルを使用しているか。ゲートウェイとサービスレベルの両方で認可が強制されているか。
-   [ ] **入力検証:** すべての入力はスキーマ（OpenAPI, JSON Schemaなど）に対して検証されているか。
-   [ ] **SSRF対策:** アウトバウンドリクエストを検証・制限し、SSRF対策が実装されているか。
-   [ ] **GraphQLセキュリティ:** クエリの深さと複雑さが制限され、本番環境ではイントロスペクションが無効化されているか。

## 3. 認証とMFA

-   [ ] **パスワードハッシュ:** パスワードは強力で低速なハッシュアルゴリズム（Argon2id, scrypt）でハッシュ化されているか。
-   [ ] **侵害パスワードチェック:** パスワードは既知の侵害リストと照合されているか。
-   [ ] **MFA:** 機密性の高いアカウントや操作に多要素認証（MFA）が実装されているか（特にWebAuthn/FIDO2のようなフィッシング耐性のある方法を推奨）。
-   [ ] **フェデレーション:** OAuth 2.0, OIDC, SAMLのような標準プロトコルが正しく安全に使用されているか。
-   [ ] **トークン:** 短命なトークンを使用し、失効メカニズムが実装されているか。

## 4. 認可とアクセス制御

-   [ ] **最小権限:** ユーザーには職務に必要な最小レベルのアクセス権のみが付与されているか。
-   [ ] **デフォルトで拒否:** アクセスリクエストのデフォルトは「拒否」になっているか。
-   [ ] **IDOR対策:** 各オブジェクトインスタンスへのアクセスが検証され、IDORが防止されているか。
-   [ ] **マスアサインメント対策:** DTOや許可リストを使い、マスアサインメント脆弱性が防止されているか。

## 5. クライアントサイドWebセキュリティ

-   [ ] **XSS対策:** コンテキストに応じたエンコーディングとサニタイズによりXSSが防止されているか。
-   [ ] **CSP:** 厳格なコンテンツセキュリティポリシー（CSP）が実装されているか。
-   [ ] **CSRF対策:** すべての状態変更リクエストにアンチCSRFトークンが使用されているか。
-   [ ] **クリックジャッキング対策:** `frame-ancestors`または`X-Frame-Options`によりクリックジャッキングが防止されているか。

## 6. クラウドとオーケストレーション (Kubernetes)

-   [ ] **RBAC:** ユーザーとサービスアカウントに最小権限を強制するため、RBACが使用されているか。
-   [ ] **ネットワークポリシー:** Pod間のトラフィックを制限するネットワークポリシーが使用されているか。
-   [ ] **シークレット管理:** KMSのような安全なシークレット管理ソリューションが使用されているか。
-   [ ] **イメージセキュリティ:** 最小限で強化されたコンテナイメージを使用し、脆弱性スキャンが実施されているか。

## 7. データとストレージのセキュリティ

-   [ ] **分離:** データベースサーバーは他のシステムから分離されているか。
-   [ ] **暗号化:** 保管中および転送中のデータは暗号化されているか。
-   [ ] **最小権限:** データベースアカウントには最小権限の原則が適用されているか。
-   [ ] **バックアップ:** データベースのバックアップは暗号化され、復元プロセスがテストされているか。

## 8. DevOps、CI/CD、コンテナ

-   [ ] **パイプラインセキュリティ:** CI/CDパイプラインは（シークレット管理、エフェメラルなランナー、セキュリティゲート等で）保護されているか。
-   [ ] **コンテナの強化:** コンテナは（非rootユーザー実行、不要なケーパビリティ削除、読み取り専用ルートFS等で）強化されているか。
-   [ ] **成果物の署名:** すべてのビルド成果物に署名があり、デプロイ前に検証されているか。

## 9. ファイルの取り扱いとアップロード

-   [ ] **検証:** ファイルアップロードは拡張子、コンテントタイプ、ファイルシグネチャによって検証されているか。
-   [ ] **ストレージ:** アップロードされたファイルはウェブルートの外に保存されているか。
-   [ ] **スキャン:** アップロードされたファイルはマルウェアスキャンされているか。
-   [ ] **安全な配信:** ファイルは正しい`Content-Type`および`Content-Disposition`ヘッダーと共に提供されているか。

## 10. フレームワークと⾔語のセキュリティ

-   [ ] **組み込み保護機能の利用:** フレームワークのセキュリティ機能（CSRF保護など）が活用されているか。
-   [ ] **安全な設定:** フレームワークと言語ランタイムの設定が強化されているか。
-   [ ] **依存関係の管理:** 依存関係は最新に保たれ、脆弱性スキャンが実施されているか。

## 11. Infrastructure as Code (IaC)

-   [ ] **ネットワークセキュリティ:** 管理サービスやデータベースへのアクセスが制限されているか。
-   [ ] **データ保護:** 保管中および転送中のデータは暗号化されているか。
-   [ ] **アクセス制御:** IAMポリシーに最小権限の原則が適用されているか。
-   [ ] **シークレット管理:** IaCテンプレートにシークレットがハードコードされていないか。

## 12. 入力検証とインジェクション対策

-   [ ] **SQLインジェクション対策:** パラメータ化クエリが使用されているか。
-   [ ] **OSコマンドインジェクション対策:** ユーザー入力を含むOSコマンドの実行が回避されているか。
-   [ ] **プロトタイプ汚染対策:** JavaScriptでプロトタイプ汚染が防止されているか（`Map`の使用、キーの検証など）（JavaScriptを使っている場合）。

## 13. ロギングと監視

-   [ ] **構造化ロギング:** ログは解析しやすい構造化形式（JSONなど）になっているか。
-   [ ] **リダクション:** ログから機密情報が編集（リダクト）されているか。
-   [ ] **完全性:** ログの完全性が（追記専用ストレージなどで）保護されているか。
-   [ ] **アラート:** セキュリティ上重要なイベントに対してアラートが設定されているか。

## 14. モバイルアプリのセキュリティ

-   [ ] **安全なストレージ:** 機密データはプラットフォームの安全なストレージに保存されているか。
-   [ ] **安全なトランスポート:** すべてのネットワーク通信にHTTPSが使用されているか。
-   [ ] **コードの完全性:** コード改ざんを検知・防止する対策が実装されているか。
-   [ ] **生体認証:** プラットフォームがサポートする生体認証が、安全なフォールバックと共に使用されているか。

## 15. プライバシーとデータ保護

-   [ ] **データ最小化:** 必要なデータのみが収集されているか。
-   [ ] **分類:** データはその機密性に基づいて分類されているか。
-   [ ] **暗号化:** 機密データは保管中および転送中に暗号化されているか。
-   [ ] **ユーザーの権利:** ユーザーが自身のデータにアクセス、修正、削除できる機能が提供されているか。

## 16. セッション管理とCookie

-   [ ] **安全なCookie:** セッションCookieに`Secure`, `HttpOnly`, `SameSite`属性が使用されているか。
-   [ ] **セッションのローテーション:** 認証・権限昇格時にセッションIDが再生成されているか。
-   [ ] **タイムアウト:** セッションにアイドルタイムアウトと絶対タイムアウトが実装されているか。
-   [ ] **盗難検出:** セッション盗難を検出・防止する対策が実装されているか。

## 17. 依存関係とサプライチェーンのセキュリティ

-   [ ] **バージョンの固定:** 依存関係は特定のバージョンに固定（ピンニング）されているか。
-   [ ] **来歴:** ビルド成果物の来歴が証明されているか。
-   [ ] **完全性:** 依存関係の完全性が検証されているか。

## 18. XMLとシリアライゼーション

-   [ ] **XXE対策:** XMLパーサーでDTDと外部エンティティが無効化されているか。
-   [ ] **スキーマ検証:** XMLはローカルの信頼できるXSDに対して検証されているか。
-   [ ] **安全なデシリアライゼーション:** 信頼できないネイティブオブジェクトのデシリアライズが回避されているか。

## 19. 暗号アルゴリズム

-   [ ] **禁止アルゴリズムの不使用:** MD5, SHA-1, DES, 3DES, RC4のような安全でないアルゴリズムが使用されていないか。
-   [ ] **安全な代替案の利用:** SHA-256, AES, ECDHEのような安全なアルゴリズムが使用されているか。

## 20. デジタル証明書

-   [ ] **有効期限:** 証明書の有効期限が監視されているか。
-   [ ] **キーの強度:** 強力なキー（RSA 2048+, ECDSA P-256+）が使用されているか。
-   [ ] **署名アルゴリズム:** 安全な署名アルゴリズム（SHA-256 with RSAなど）が使用されているか。
-   [ ] **自己署名証明書の不使用:** 本番環境で自己署名証明書が使用されていないか。

## 21. ハードコードされた認証情報

-   [ ] **ハードコードの禁止:** ソースコードにシークレット、パスワード、APIキーがハードコードされていないか。
-   [ ] **安全な代替案:** KMSやVaultのような安全なシークレット管理ソリューションが使用されているか。