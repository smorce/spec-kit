目的:
- 仕様駆動TDDの分散システム品質を保つため、共通の「マイクロサービス実装チェックリスト」を生成・更新する。
- ただし、今回の仕様とは合わないものは除外する。不明な場合はユーザーに確認する。

適用範囲:
- [000-architecture] 全体アーキテクチャの基盤原則
- 001- 以降の各 feature（＝各マイクロサービス）

======= ここは毎回書き換える。例えば課金が不要なら Payments の項目は消すなど。 =======
前提スタック:
- Next.js (SSR) → OpenNext 経由 Cloudflare Workers（SSR/API/Middleware）
- DB: Neon (serverless PostgreSQL)
- Auth: Supabase Auth（JWT、RLS: 原則 `user_id = auth.uid()`）
- Storage: Cloudflare R2（画像配信は Cloudflare Images）
- Payments: Stripe
- Domain/CDN/Security: Cloudflare（Registrar/CDN/WAF/Cache）
- Perf: wrangler.jsonc `minify: true`、画像はオンデマンド変換

指示:
- 下記カテゴリで、実装者が Red/Green/Refactor の各段階で確認できる粒度のチェック項目を作り、受け入れ条件（Accept/Fail例、観測可能な証拠）を付与する。
- 生成物は `specs/[ブランチ名]/checklists/microservices.md` に Markdown として**上書き保存**。

### マイクロサービス実装チェックリスト

開発者が分散システムの品質を確保するために確認すべき項目です。TDDサイクル（Red/Green/Refactor）の各段階で、以下の観点が満たされていることを確認します。

#### サービス設計と境界

- [ ] **疎結合と高凝集**: サービスが単一のビジネスドメイン（境界づけられたコンテキスト）に集中しており（高凝集）、他のサービスへの依存が最小限（疎結合）になっているか？
- [ ] **独立したデプロイ**: サービスが独立してデプロイ、スケーリング可能になっているか？

#### データ管理

- [ ] **Database per Service（最重要）**: 他のサービスのデータベースに直接アクセスしていないか？データアクセスは必ずAPIまたはイベント経由で行われているか？
- [ ] **トランザクション管理**: サービス内のトランザクション境界が適切に設定されているか？
- [ ] **結果整合性**: 複数サービスにまたがるトランザクションが必要な場合、結果整合性を保つためのアプローチ（例: Sagaパターン）が適切に実装されているか？
  - [ ] （Sagaの場合）補償トランザクションやイベント処理が正しく実装されているか？（*TDDで失敗シナリオをテスト*）
- [ ] **CQRS（検討）**: パフォーマンス要件に応じて、更新系と参照系でデータモデルを分離することが検討・実装されているか？

#### 通信とAPI契約

- [ ] **API契約の遵守**: 実装されたエンドポイント、リクエスト/レスポンスのスキーマが `OpenAPI.yaml` に厳密に一致しているか？
- [ ] **通信プロトコル**: 同期通信（REST/gRPC）と非同期通信（メッセージング）が、ユースケースに応じて適切に使い分けられているか？
- [ ] **入力検証**: 全ての入力パラメータに対して適切なバリデーションが実装されているか？（*TDDのRedフェーズでテストケースを追加*）
- [ ] **エラーレスポンス**: 想定されるエラー（4xx系、5xx系）に対して、定義された共通フォーマットでレスポンスを返しているか？（*TDDのRedフェーズでテストケースを追加*）

#### 耐障害性（レジリエンス）

連鎖障害を防ぎ、システムの可用性を維持するための仕組みが備わっているか。（注：サービスメッシュで提供される機能は、設定が適切かを確認する）

- [ ] **サーキットブレーカー**: 外部サービスや他のマイクロサービスへの呼び出し部分に、サーキットブレーカーが適用され、連鎖障害を防ぐ設計になっているか？
- [ ] **タイムアウト**: 全ての外部呼び出しに適切なタイムアウトが設定されているか？長時間ブロックされていないか？
- [ ] **リトライ戦略**: 一時的な障害に対して、適切なリトライ戦略（例：指数バックオフ）が実装されているか？処理の冪等性が担保されているか？
- [ ] **フォールバック**: 依存サービスが利用不可の場合に、定義されたフォールバック処理（例：キャッシュの利用、機能制限）が動作するか？（*TDDで障害をシミュレートしてテスト*）

#### オブザーバビリティ（可観測性）

システムの状態を把握し、問題を迅速に特定できる能力が備わっているか。

- [ ] **分散トレーシング（Distributed Tracing）（最重要）**:
  - [ ] 受信したリクエストから標準化されたトレースID（例: W3C Trace Contextの`traceparent`ヘッダー）を正しく抽出しているか？
  - [ ] 外部へのリクエスト（HTTP/gRPC/メッセージ）送信時に、トレースIDを必ず伝播させているか？
- [ ] **構造化ロギング**: ログは機械可読な形式（JSONなど）で出力され、追跡に必要な情報（タイムスタンプ、レベル、トレースIDなど）が含まれているか？機密情報が含まれていないか？
- [ ] **メトリクス監視**: 詳細設計書で定義された主要なメトリクス（レスポンスタイム、エラーレート、スループットなど）が計測されているか？