# セキュリティチェックリスト: Memorium

## 適用対象と前提
- **対象**: `[000-architecture]` 基盤アーキテクチャ、`001-memorium-md` ブランチ配下の各マイクロサービス、MiniRAG統合、およびTraefikベースのローカルオーケストレーション。
- **前提**:
  - ローカル個人開発環境（Docker Compose）での単一ユーザー運用。
  - データはPostgreSQL・MiniRAG・YAMLファイルに平文保存し、OSアカウントのアクセス制御を唯一の保護とする。
  - インターネット向け公開は行わず、外部入出力はファイルベースのみ。
- **除外**:
  - TLS/暗号化/KMS/MFA/クラウドKubernetes/IaC/モバイルアプリ関連のチェックは仕様外として削除済み。
  - 将来のマルチユーザーや外部連携に関する認証・暗号化要件は別途仕様化されるまで対象外。

---

## [000-architecture] 基盤ベースライン

### 環境・ネットワーク境界
- [ ] Traefikおよび各サービスのDocker Compose設定で、ホスト公開ポートが最小限（フロント/BFFのみ）であることを確認済み。
- [ ] PostgreSQL・MiniRAG・NATS・内部APIは`internal`ネットワークに限定され、`0.0.0.0`での外部公開が無効化されている。
- [ ] Composeファイルに`restart: unless-stopped`等の自動再起動設定を適用し、異常終了時も未処理セッション状態を再開できるドキュメントがある。

### API契約・入力検証
- [ ] すべてのREST/SignalRエンドポイントに対し、OpenAPI/AsyncAPI/JSON Schemaでリクエスト/レスポンスを強制し、自動生成テスト（schemathesis）でRed → Green → Refactorの証跡を保持している。
- [ ] MiniRAG入出力に対するスキーマバリデーションを実装し、危険なメタデータ（例: ファイルパス、コマンド文字列）の混入テストを準備済み。
- [ ] NATSイベント契約は型定義（pydantic/avro等）で固定し、契約破りがRedテストで検出される仕組みをCIに組み込んでいる。

### 認証・セッション（単一ユーザー前提の確認）
- [ ] 「単一ユーザー・ローカル利用」の前提と、未認証APIを許容する根拠が仕様書とリリースノートに明記されている。
- [ ] SignalRセッションおよびドラフト再開トークンはローカルファイル／DBでのみ取り扱い、外部送信していない。
- [ ] 将来多ユーザー化する際の認証・認可導入計画（バックログ）が記録されている。

### ロギングとプライバシー
- [ ] ログ出力はJSON Lines形式で統一し、日記本文や個人識別情報をマスクするフィルタがミドルウェアとしてテスト済み。
- [ ] Loki/Grafana等のローカル可観測性ツールはCompose内ネットワークに閉じ、認証無しアクセスで個人情報が閲覧されないようポート公開を制限している。
- [ ] 監査目的で残すログ項目と保持期間（ローカルファイルのローテーション含む）が仕様化されている。

### 依存関係・サプライチェーン
- [ ] Python依存は`uv`でバージョン固定（`uv.lock`）済みであり、`uv run --link-mode=copy`経由のインストール手順が最新化されている。
- [ ] MiniRAGコンテナイメージおよびPostgreSQLイメージのバージョンを明示し、脆弱性スキャン結果（手動でも可）を定期的にレビューするプロセスがある。
- [ ] GitフックまたはCIで`pip-audit`/`npm audit`等のスキャンを実行し、結果をissueに記録している。

---

## [001-memorium-md] サービス横断チェック

### 共通（FastAPIサービス全般）
- [ ] Pydanticバリデーションで未定義フィールドの受け入れを拒否し、422レスポンスがテストで保証されている。
- [ ] 例外ハンドラが統一され、スタックトレースや未加工入力がレスポンスに露出しないことを自動テストしている。
- [ ] 外部ファイルアクセスを伴う処理（テンプレート、YAML、エクスポート）はホワイトリストパスに制限し、パストラバーサルテストをRed→Greenで管理している。

### orchestrator-gateway
- [ ] CSRFトークンまたは同等のリクエスト署名をREST/SignalR双方で検証し、不一致時に403となるテストがある。
- [ ] レートリミット（Traefikまたはアプリ側）が基本設定され、同一IP連続アクセスでブロックされることを確認済み。
- [ ] 許可オリジンリストが固定され、SignalRハンドシェイクでOrigin/Refererチェックが機能することをテストしている。

### Journal Ingestion Service
- [ ] セッション状態保存時に、入力日記本文のサイズ上限・禁止文字（制御文字等）を検証するテストがある。
- [ ] PostgreSQL接続情報が環境変数のみから供給され、ソースコードに資格情報をハードコードしていない。
- [ ] セッション再開APIが認証レスでも推測困難な識別子（UUID v4等）を使用し、ブルートフォース対策としてレート制御が設定されている。

### Preview Orchestrator Service
- [ ] プロンプトテンプレート差し込み時にユーザー入力をエスケープし、LLMプロンプトインジェクション防止テスト（悪意ある指示でMiniRAGやファイル操作が許可されないこと）が設定されている。
- [ ] 深掘り質問生成の履歴をロギングする際、個人情報がマスクされることを確認するテストがある。
- [ ] LLM呼び出しエラー時のフォールバックが定義され、例外情報がクライアントへ漏洩しない（一般化されたエラーメッセージ）ことを確認済み。

### Memory Vault Service
- [ ] MiniRAGへ投入するデータ前処理で、HTML/スクリプト等の危険プレーンテキストを無害化するフィルタが実装されている。
- [ ] PostgreSQLのテーブル権限が当該サービスユーザーに限定され、他サービスアカウントから直接参照しない構成をComposeとドキュメントで保証している。
- [ ] NATS経由で受信する保存イベントのスキーマバージョンチェックを行い、互換性が崩れた場合に処理を停止させるテストがある。

### Profile Service
- [ ] YAMLプロファイル更新処理で排他制御（ファイルロックまたはシリアライザ内ミューテックス）を行い、競合テストがRed→Greenで管理されている。
- [ ] プロファイル差分生成時に差分のサニタイズを行い、個人情報が他ログへコピーされないことを確認している。
- [ ] バックアップ手順（Gitコミットまたはファイルコピー）が運用Runbookに記載され、復元テストが実施済み。

### Search Aggregation Service
- [ ] 自然文クエリのトークナイズ時に、MiniRAG APIへ渡すクエリ長を制限し、DoSや過剰計算を防ぐテストを有している。
- [ ] 各検索軸のレスポンスを統合する際、ソース未検証データをそのまま返却しない（HTMLエスケープ等）ことをテストで保証している。
- [ ] MiniRAG接続障害時のタイムアウトとフォールバック表示（エラー詳細を隠蔽）が仕様化され、E2Eテストで確認されている。

### MiniRAG コンポーネント
- [ ] MiniRAG APIエンドポイントはCompose内部ネットワークのみで公開し、推論用APIキーや管理ポートを無効化している。
- [ ] ドキュメント投入スクリプトで`documents/MiniRAG`配下以外のパスを拒否し、意図しないファイル取り込みが発生しないことをテストしている。
- [ ] embeddings再生成ジョブの実行権限が明示され、スクリプトに危険なシェル実行（`os.system`等）がないことをコードレビューで確認している。

### フロントエンド / SignalR クライアント
- [ ] ビルド済みSPAの静的ホスティングにおいて、`Content-Security-Policy`で外部スクリプト読込を禁止する設定が存在する。
- [ ] SignalRクライアントは再接続リトライ回数・間隔が仕様化され、ログに機密情報を残さない設定がある。
- [ ] フロントエンドからのAPI呼び出しは、期待するHTTPメソッド／ヘッダーのみを送信し、不正な値をUI側でブロックする。

---

## 運用・手順
- [ ] `.env.spec` に含まれる全環境変数について、用途・最小権限・初期化手順をRunbookに記録済み。
- [ ] 週次のPostgreSQLダンプおよびプロファイルYAMLのコピー手順が自動化（または明文化）され、復旧演習結果が記録されている。
- [ ] ローカルマシンのOSアカウント権限管理（スクリーンロック、フルディスクアクセス制限）がMemorium利用開始前にチェックされるプロセスがある。
- [ ] 既知の脆弱性情報やライブラリアップデートの確認頻度（例: 月次レビュー）が定義され、実施ログを残している。
- [ ] 仕様変更や新機能追加時に本チェックリストを更新する手順（Pull Requestテンプレート等）が整備されている。
