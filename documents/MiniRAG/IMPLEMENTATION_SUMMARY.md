# Multi-Field Search å®Ÿè£…ã‚µãƒãƒªãƒ¼

## å®Ÿè£…å®Œäº†æ—¥
2025-10-04

## å®Ÿè£…å†…å®¹

### Phase 1: ãƒãƒ£ãƒ³ã‚¯ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ã®æ‹¡å¼µ âœ…

#### 1.1 ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è­˜åˆ¥é–¢æ•°
**ãƒ•ã‚¡ã‚¤ãƒ«**: `minirag_app/minirag/minirag.py`
**ãƒ¡ã‚½ãƒƒãƒ‰**: `_extract_text_fields()`

- æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ï¼ˆdictï¼‰ã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è‡ªå‹•è­˜åˆ¥
- `text_field_keys` ã«å«ã¾ã‚Œã‚‹ã‚­ãƒ¼ã€ã¾ãŸã¯ `str`/`list` å‹ã®å€¤ã‚’æŠ½å‡º
- æ•°å€¤ãªã©ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã¨åˆ†é›¢

#### 1.2 ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åˆ¥ãƒãƒ£ãƒ³ã‚¯ç”Ÿæˆ
**ãƒ•ã‚¡ã‚¤ãƒ«**: `minirag_app/minirag/minirag.py`
**ãƒ¡ã‚½ãƒƒãƒ‰**: `_generate_chunks_per_field()`

- å„ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã”ã¨ã«å€‹åˆ¥ã®ãƒãƒ£ãƒ³ã‚¯ã‚’ç”Ÿæˆ
- å„ãƒãƒ£ãƒ³ã‚¯ã« `metadata: {"text_field": "field_name"}` ã‚’ä»˜ä¸
- çµ±åˆç‰ˆãƒãƒ£ãƒ³ã‚¯ï¼ˆ`text_field: "_all"`ï¼‰ã‚‚ç”Ÿæˆ

#### 1.3 ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³çµ±åˆ
**ãƒ•ã‚¡ã‚¤ãƒ«**: `minirag_app/minirag/minirag.py`
**ãƒ¡ã‚½ãƒƒãƒ‰**: `apipeline_process_enqueue_documents()`

- ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åˆ†å‰²ãŒæœ‰åŠ¹ãªå ´åˆã€æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ã‚’è‡ªå‹•çš„ã«åˆ†å‰²ã—ã¦ãƒãƒ£ãƒ³ã‚¯åŒ–
- å¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ã€å¾“æ¥ã®æ–‡å­—åˆ—å…¥åŠ›ã‚‚ã‚µãƒãƒ¼ãƒˆ

### Phase 2: ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ‹¡å¼µ âœ…

#### 2.1 QueryParam æ‹¡å¼µ
**ãƒ•ã‚¡ã‚¤ãƒ«**: `minirag_app/minirag/base.py`

```python
@dataclass
class QueryParam:
    ...
    target_fields: Optional[list[str]] = None
```

- æ¤œç´¢å¯¾è±¡ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æŒ‡å®šã™ã‚‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¿½åŠ 
- `None`: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆ`_all`ï¼‰
- `["title"]`: å˜ä¸€ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
- `["title", "description"]`: è¤‡æ•°ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰

#### 2.2 target_fields â†’ metadata_filter å¤‰æ›
**ãƒ•ã‚¡ã‚¤ãƒ«**: `minirag_app/minirag/minirag.py`
**ãƒ¡ã‚½ãƒƒãƒ‰**: `_apply_target_fields_filter()`

- `target_fields` ã‚’å†…éƒ¨çš„ã« `metadata_filter` ã«å¤‰æ›
- æ—¢å­˜ã® `metadata_filter` ã¨ãƒãƒ¼ã‚¸
- è¤‡æ•°ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å ´åˆã¯ãƒªã‚¹ãƒˆã¨ã—ã¦æ¸¡ã™

#### 2.3 PostgreSQL IN å¥ã‚µãƒãƒ¼ãƒˆ
**ãƒ•ã‚¡ã‚¤ãƒ«**: `minirag_app/minirag/kg/postgres_impl.py`
**ãƒ¡ã‚½ãƒƒãƒ‰**: `PGVectorStorage.query()`

- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚£ãƒ«ã‚¿ã®å€¤ãŒãƒªã‚¹ãƒˆã®å ´åˆã€INå¥ã‚’ç”Ÿæˆ
- `metadata->>'text_field' IN ('title', 'description')`
- JSONBå‹ã®æŸ”è»Ÿãªå‡¦ç†ã‚’ã‚µãƒãƒ¼ãƒˆ

### Phase 3: æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ã‚µãƒãƒ¼ãƒˆ âœ…

#### 3.1 ainsert æ‹¡å¼µ
**ãƒ•ã‚¡ã‚¤ãƒ«**: `minirag_app/minirag/minirag.py`
**ãƒ¡ã‚½ãƒƒãƒ‰**: `_prepare_insert_payload()`

- æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ã® `_original_data` ã‚’ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã«ä¿å­˜
- ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åˆ†å‰²æ™‚ã«å…ƒã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’å‚ç…§å¯èƒ½ã«

### Phase 4: ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ âœ…

#### 4.1 ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
**ãƒ•ã‚¡ã‚¤ãƒ«**: `002_add_text_field_to_existing_chunks.sql`

- æ—¢å­˜ãƒãƒ£ãƒ³ã‚¯ã« `text_field="_all"` ã‚’è¿½åŠ 
- `metadata->>'text_field'` ã«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½œæˆ
- Rollbackç”¨ã®ã‚³ãƒãƒ³ãƒ‰ã‚‚æä¾›

#### 4.2 ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
**ãƒ•ã‚¡ã‚¤ãƒ«**: `MULTI_FIELD_SEARCH_GUIDE.md`

- æ©Ÿèƒ½æ¦‚è¦
- ä½¿ç”¨ä¾‹
- è¨­å®šã‚ªãƒ—ã‚·ãƒ§ãƒ³
- ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

## è¨­å®šãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿

### MiniRAG åˆæœŸåŒ–æ™‚

```python
rag = MiniRAG(
    enable_field_splitting=True,  # ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åˆ†å‰²ã®æœ‰åŠ¹åŒ–
    generate_combined_chunk=True,  # çµ±åˆç‰ˆãƒãƒ£ãƒ³ã‚¯ç”Ÿæˆ
    text_field_keys=["title", "description", "summary", ...],  # è‡ªå‹•èªè­˜ã™ã‚‹ã‚­ãƒ¼
)
```

### ã‚¯ã‚¨ãƒªæ™‚

```python
param = QueryParam(
    mode="light",
    target_fields=["title", "description"],  # æ¤œç´¢å¯¾è±¡ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
    metadata_filter={"category": "order"},   # è¿½åŠ ãƒ•ã‚£ãƒ«ã‚¿
)
```

## å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§

### ã‚³ã‚¢æ©Ÿèƒ½
1. `minirag_app/minirag/base.py`
   - `QueryParam` ã« `target_fields` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¿½åŠ 

2. `minirag_app/minirag/minirag.py`
   - è¨­å®šãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¿½åŠ ï¼ˆ`enable_field_splitting`, `generate_combined_chunk`, `text_field_keys`ï¼‰
   - `_extract_text_fields()` ãƒ¡ã‚½ãƒƒãƒ‰è¿½åŠ 
   - `_generate_chunks_per_field()` ãƒ¡ã‚½ãƒƒãƒ‰è¿½åŠ 
   - `_apply_target_fields_filter()` ãƒ¡ã‚½ãƒƒãƒ‰è¿½åŠ 
   - `apipeline_process_enqueue_documents()` ä¿®æ­£
   - `_prepare_insert_payload()` ä¿®æ­£
   - `aquery()` ä¿®æ­£

3. `minirag_app/minirag/kg/postgres_impl.py`
   - `PGVectorStorage.query()` ã§INå¥ã‚µãƒãƒ¼ãƒˆè¿½åŠ 

### ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
4. `002_add_text_field_to_existing_chunks.sql`
   - æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

5. `MULTI_FIELD_SEARCH_GUIDE.md`
   - æ©Ÿèƒ½ã‚¬ã‚¤ãƒ‰

6. `IMPLEMENTATION_SUMMARY.md` (ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«)
   - å®Ÿè£…ã‚µãƒãƒªãƒ¼

## ãƒ†ã‚¹ãƒˆæ¨å¥¨äº‹é …

### 1. åŸºæœ¬æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ

```python
# æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ã®ã‚¤ãƒ³ã‚µãƒ¼ãƒˆ
data = {
    "doc_id": "test-001",
    "title": "ãƒ†ã‚¹ãƒˆã‚¿ã‚¤ãƒˆãƒ«",
    "description": "ãƒ†ã‚¹ãƒˆèª¬æ˜æ–‡",
    "metadata": {"category": "test"}
}
await rag.ainsert([data])

# ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æŒ‡å®šæ¤œç´¢
param = QueryParam(mode="light", target_fields=["title"])
answer, source = await rag.aquery("ãƒ†ã‚¹ãƒˆ", param=param)
```

### 2. è¤‡æ•°ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æ¤œç´¢ãƒ†ã‚¹ãƒˆ

```python
param = QueryParam(
    mode="light",
    target_fields=["title", "description"]
)
answer, source = await rag.aquery("ãƒ†ã‚¹ãƒˆ", param=param)
```

### 3. ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚£ãƒ«ã‚¿ä½µç”¨ãƒ†ã‚¹ãƒˆ

```python
param = QueryParam(
    mode="light",
    target_fields=["title"],
    metadata_filter={"category": "test"}
)
answer, source = await rag.aquery("ãƒ†ã‚¹ãƒˆ", param=param)
```

### 4. å¾Œæ–¹äº’æ›æ€§ãƒ†ã‚¹ãƒˆ

```python
# target_fields ãªã— â†’ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆ_allï¼‰
param = QueryParam(mode="light")
answer, source = await rag.aquery("ãƒ†ã‚¹ãƒˆ", param=param)
```

## æ—¢çŸ¥ã®åˆ¶é™äº‹é …

1. **ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å¢—åŠ **
   - ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æ•°ã«å¿œã˜ã¦ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä½¿ç”¨é‡ãŒå¢—åŠ 
   - å¯¾ç­–: `generate_combined_chunk=False` ã§çµ±åˆç‰ˆã‚’ç„¡åŠ¹åŒ–

2. **ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£/ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒƒãƒ—**
   - ç¾åœ¨ã¯ãƒãƒ£ãƒ³ã‚¯ã®ã¿ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åˆ†å‰²ã‚’ã‚µãƒãƒ¼ãƒˆ
   - ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£/ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒƒãƒ—ã¯å¾“æ¥é€šã‚Šçµ±åˆç‰ˆã®ã¿

3. **æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³**
   - ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®æ‰‹å‹•å®Ÿè¡ŒãŒå¿…è¦

## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

### æ‹¡å¼µæ¡ˆ

1. **å‹•çš„ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¹ã‚­ãƒ¼ãƒå¯¾å¿œ**
   - ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã§å®šç¾©ã•ã‚ŒãŸä»»æ„ã®ãƒ†ã‚­ã‚¹ãƒˆã‚«ãƒ©ãƒ ã‚’ã‚µãƒãƒ¼ãƒˆ

2. **ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£/ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒƒãƒ—ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åˆ†å‰²**
   - KGæ¤œç´¢ã§ã‚‚ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æŒ‡å®šæ¤œç´¢ã‚’å¯èƒ½ã«

3. **ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰é‡ã¿ä»˜ã‘**
   - `target_fields` ã«é‡ã¿ã‚’æŒ‡å®šï¼ˆä¾‹: `{"title": 2.0, "description": 1.0}`ï¼‰

4. **è‡ªå‹•ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³**
   - ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã«è‡ªå‹•çš„ã«æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

## å®Œäº†ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹

- âœ… Phase 1: ãƒãƒ£ãƒ³ã‚¯ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ã®æ‹¡å¼µ
- âœ… Phase 2: ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ‹¡å¼µ
- âœ… Phase 3: æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ã‚µãƒãƒ¼ãƒˆ
- âœ… Phase 4: ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

**å…¨ãƒ•ã‚§ãƒ¼ã‚ºå®Œäº†ï¼** ğŸ‰
